---
import BaseLayout from '../layouts/BaseLayout.astro';

const instructors = [
  {
    name: 'Karen Miles',
    initials: 'KM',
    title: '2024 World FITASC Champion, Ladies',
    image: '/images/instructors/karen-miles.jpg',
    bio: 'World FITASC Champion and elite shooting coach specializing in competitive strategy and mental game.',
  },
  {
    name: 'Gebben Miles',
    initials: 'GM',
    title: '2026 Jack Links Cup Champion',
    image: '/images/instructors/gebben-miles.jpg',
    bio: 'Jack Links Cup Champion and master instructor known for technical precision and fundamentals.',
  },
];
---

<BaseLayout
  title="Book a Lesson | Sporting Clays Academy"
  description="Schedule private instruction with world champions Karen Miles and Gebben Miles. Personalized coaching for all skill levels."
>
  <!-- Header -->
  <section class="bg-gradient-to-b from-slate-950 to-slate-900 py-16 sm:py-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h1 class="text-4xl sm:text-5xl font-bold text-white mb-4">Book Private Instruction</h1>
      <p class="text-slate-300 text-lg max-w-2xl mx-auto">
        One-on-one coaching with world champions Karen and Gebben Miles.
        Select your instructor and choose a time that works for you.
      </p>
    </div>
  </section>

  <!-- Main Booking Interface -->
  <section class="py-12 sm:py-16 bg-slate-950">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      
      <!-- Tab Navigation -->
      <div class="flex gap-2 mb-8 border-b border-slate-800">
        <button
          id="tab-book"
          class="booking-tab px-6 py-3 text-sm font-semibold transition-colors border-b-2 border-amber-500 text-amber-500"
          data-tab="book"
        >
          Book a Lesson
        </button>
        <button
          id="tab-my-bookings"
          class="booking-tab px-6 py-3 text-sm font-semibold transition-colors border-b-2 border-transparent text-slate-400 hover:text-slate-300"
          data-tab="my-bookings"
        >
          My Bookings
        </button>
      </div>

      <!-- Book a Lesson View -->
      <div id="view-book" class="booking-view">
        
        <!-- Step 1: Select Instructor -->
        <div id="step-instructor" class="booking-step">
          <h2 class="text-2xl font-bold text-white mb-6">Select Your Instructor</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl">
            {instructors.map((instructor) => (
              <button
                class="instructor-card bg-slate-900 border-2 border-slate-700 rounded-2xl p-6 hover:-translate-y-1 hover:shadow-lg hover:shadow-slate-900/50 transition-all duration-300 text-left hover:border-amber-500/50"
                data-instructor={instructor.name}
              >
                <div class="w-24 h-24 rounded-full bg-gradient-to-br from-amber-500/20 to-slate-800 flex items-center justify-center mx-auto mb-4 border-2 border-slate-700 overflow-hidden relative">
                  <span class="text-2xl font-bold text-amber-500">{instructor.initials}</span>
                </div>
                <h3 class="text-xl font-semibold text-white text-center mb-1">{instructor.name}</h3>
                <p class="text-amber-500 text-sm text-center mb-3">{instructor.title}</p>
                <p class="text-slate-300 text-sm text-center leading-relaxed">{instructor.bio}</p>
              </button>
            ))}
          </div>
        </div>

        <!-- Step 2: Select Time Slot -->
        <div id="step-calendar" class="booking-step hidden">
          <div class="flex items-center justify-between mb-6">
            <button id="back-to-instructor" class="text-amber-500 hover:text-amber-400 text-sm font-medium transition-colors">
              ← Back to Instructors
            </button>
            <h2 class="text-2xl font-bold text-white">Select a Time</h2>
            <div class="w-24"></div>
          </div>

          <div class="max-w-5xl mx-auto">
            <div id="selected-instructor-info" class="bg-slate-900 border border-slate-700 rounded-xl p-4 mb-6 flex items-center gap-4">
              <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-500/20 to-slate-800 flex items-center justify-center border border-slate-700">
                <span id="instructor-initials-display" class="text-lg font-bold text-amber-500"></span>
              </div>
              <div>
                <div id="instructor-name-display" class="text-white font-semibold"></div>
                <div id="instructor-title-display" class="text-slate-400 text-sm"></div>
              </div>
            </div>

            <!-- Week View Calendar -->
            <div class="bg-slate-900 border border-slate-700 rounded-2xl p-6">
              <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                  <button id="prev-week" class="text-amber-500 hover:text-amber-400 font-bold text-xl transition-colors" title="Previous week">
                    &lt;
                  </button>
                  <h3 class="text-lg font-semibold text-white"><span id="week-display"></span></h3>
                  <button id="next-week" class="text-amber-500 hover:text-amber-400 font-bold text-xl transition-colors" title="Next week">
                    &gt;
                  </button>
                </div>
                <div class="flex gap-2 text-xs">
                  <span class="flex items-center gap-1.5">
                    <div class="w-3 h-3 bg-emerald-500/20 border border-emerald-500 rounded"></div>
                    <span class="text-slate-400">Available</span>
                  </span>
                  <span class="flex items-center gap-1.5 ml-3">
                    <div class="w-3 h-3 bg-slate-700 border border-slate-600 rounded"></div>
                    <span class="text-slate-400">Booked</span>
                  </span>
                </div>
              </div>

              <div id="calendar-grid" class="grid grid-cols-7 gap-2">
                <!-- Calendar will be generated by JS -->
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: Booking Form -->
        <div id="step-form" class="booking-step hidden">
          <div class="flex items-center justify-between mb-6">
            <button id="back-to-calendar" class="text-amber-500 hover:text-amber-400 text-sm font-medium transition-colors">
              ← Back to Calendar
            </button>
            <h2 class="text-2xl font-bold text-white">Confirm Your Booking</h2>
            <div class="w-24"></div>
          </div>

          <div class="max-w-2xl mx-auto">
            <div class="bg-slate-900 border border-slate-700 rounded-xl p-4 mb-6">
              <div class="flex items-center justify-between">
                <div>
                  <div id="form-instructor-name" class="text-white font-semibold"></div>
                  <div id="form-time-slot" class="text-amber-500 text-sm"></div>
                </div>
              </div>
            </div>

            <form id="booking-form" class="bg-slate-900 border border-slate-700 rounded-2xl p-6 space-y-5">
              <div>
                <label for="student-name" class="block text-sm font-medium text-slate-300 mb-2">Your Name</label>
                <input
                  type="text"
                  id="student-name"
                  required
                  class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                  placeholder="John Doe"
                />
              </div>

              <div>
                <label for="student-email" class="block text-sm font-medium text-slate-300 mb-2">Email Address</label>
                <input
                  type="email"
                  id="student-email"
                  required
                  class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                  placeholder="john@example.com"
                />
              </div>

              <div>
                <label for="lesson-type" class="block text-sm font-medium text-slate-300 mb-2">Lesson Type</label>
                <select
                  id="lesson-type"
                  required
                  class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                >
                  <option value="">Select a lesson type...</option>
                  <option value="FITASC">FITASC</option>
                  <option value="Sporting Clays">Sporting Clays</option>
                  <option value="Fundamentals">Fundamentals</option>
                  <option value="Mental Game">Mental Game</option>
                </select>
              </div>

              <div>
                <label for="lesson-notes" class="block text-sm font-medium text-slate-300 mb-2">Notes (Optional)</label>
                <textarea
                  id="lesson-notes"
                  rows="4"
                  class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent resize-none"
                  placeholder="Tell us about your goals, experience level, or specific areas you'd like to work on..."
                ></textarea>
              </div>

              <button
                type="submit"
                class="w-full bg-gradient-to-br from-amber-400 to-amber-500 hover:from-amber-300 hover:to-amber-400 text-slate-950 font-bold py-3 rounded-lg shadow-md shadow-amber-500/40 hover:shadow-lg hover:shadow-amber-500/60 transition-all duration-200"
              >
                Confirm Booking
              </button>
            </form>
          </div>
        </div>

        <!-- Step 4: Confirmation -->
        <div id="step-confirmation" class="booking-step hidden">
          <div class="max-w-2xl mx-auto">
            <div class="mb-6">
              <button id="back-to-calendar-from-confirmation" class="text-amber-500 hover:text-amber-400 text-sm font-medium transition-colors">
                ← Back to Calendar
              </button>
            </div>
            <div class="text-center">
            <div class="w-20 h-20 bg-emerald-500/20 border-2 border-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6">
              <svg class="w-10 h-10 text-emerald-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
            </div>
            
            <h2 class="text-3xl font-bold text-white mb-3">Booking Confirmed!</h2>
            <p class="text-slate-300 mb-8">Your lesson has been scheduled. A confirmation email has been sent to your inbox.</p>

            <div class="bg-slate-900 border border-slate-700 rounded-2xl p-6 mb-8 text-left">
              <div class="space-y-3">
                <div class="flex justify-between items-center border-b border-slate-800 pb-3">
                  <span class="text-slate-400 text-sm">Instructor</span>
                  <span id="confirm-instructor" class="text-white font-semibold"></span>
                </div>
                <div class="flex justify-between items-center border-b border-slate-800 pb-3">
                  <span class="text-slate-400 text-sm">Date & Time</span>
                  <span id="confirm-datetime" class="text-white font-semibold"></span>
                </div>
                <div class="flex justify-between items-center border-b border-slate-800 pb-3">
                  <span class="text-slate-400 text-sm">Lesson Type</span>
                  <span id="confirm-lesson-type" class="text-white font-semibold"></span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-slate-400 text-sm">Student</span>
                  <span id="confirm-student" class="text-white font-semibold"></span>
                </div>
              </div>
            </div>

            <div class="flex gap-3 justify-center">
              <button
                id="book-another"
                class="bg-gradient-to-br from-amber-400 to-amber-500 hover:from-amber-300 hover:to-amber-400 text-slate-950 font-bold px-6 py-2.5 rounded-lg shadow-md shadow-amber-500/40 hover:shadow-lg hover:shadow-amber-500/60 transition-all duration-200"
              >
                Book Another Lesson
              </button>
              <button
                id="view-my-bookings"
                class="bg-slate-800 hover:bg-slate-700 border border-slate-700 text-white font-semibold px-6 py-2.5 rounded-lg transition-all duration-200"
              >
                View My Bookings
              </button>
            </div>
            </div>
          </div>
        </div>

      </div>

      <!-- My Bookings View -->
      <div id="view-my-bookings" class="booking-view hidden">
        <h2 class="text-2xl font-bold text-white mb-6">My Upcoming Lessons</h2>
        
        <div class="max-w-3xl mx-auto space-y-4">
          <!-- Sample Booking 1 -->
          <div class="bg-slate-900 border border-slate-700 rounded-xl p-5 hover:border-slate-600 transition-colors">
            <div class="flex items-start justify-between">
              <div class="flex gap-4">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-500/20 to-slate-800 flex items-center justify-center border border-slate-700 shrink-0">
                  <span class="text-sm font-bold text-amber-500">KM</span>
                </div>
                <div>
                  <h3 class="text-white font-semibold mb-1">Karen Miles</h3>
                  <p class="text-amber-500 text-sm mb-2">Monday, Feb 24, 2026 • 10:00 AM EST</p>
                  <p class="text-slate-400 text-sm"><span class="font-medium text-slate-300">Lesson:</span> FITASC</p>
                </div>
              </div>
              <button class="text-slate-500 hover:text-slate-400 text-sm font-medium transition-colors">
                Reschedule
              </button>
            </div>
          </div>

          <!-- Sample Booking 2 -->
          <div class="bg-slate-900 border border-slate-700 rounded-xl p-5 hover:border-slate-600 transition-colors">
            <div class="flex items-start justify-between">
              <div class="flex gap-4">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-500/20 to-slate-800 flex items-center justify-center border border-slate-700 shrink-0">
                  <span class="text-sm font-bold text-amber-500">GM</span>
                </div>
                <div>
                  <h3 class="text-white font-semibold mb-1">Gebben Miles</h3>
                  <p class="text-amber-500 text-sm mb-2">Thursday, Feb 27, 2026 • 2:00 PM EST</p>
                  <p class="text-slate-400 text-sm"><span class="font-medium text-slate-300">Lesson:</span> Mental Game</p>
                </div>
              </div>
              <button class="text-slate-500 hover:text-slate-400 text-sm font-medium transition-colors">
                Reschedule
              </button>
            </div>
          </div>
        </div>

        <div class="max-w-3xl mx-auto mt-8">
          <button
            id="book-new-from-my-bookings"
            class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 text-white font-semibold py-3 rounded-lg transition-all duration-200"
          >
            + Book Another Lesson
          </button>
        </div>
      </div>

    </div>
  </section>

  <script>
    // State
    let selectedInstructor = null;
    let selectedSlot = null;
    let weekOffset = 0; // 0 = current week, -1 = previous week, +1 = next week

    const instructorData = {
      'Karen Miles': { initials: 'KM', title: '2024 World FITASC Champion, Ladies', id: 'aaaaaaaa-0001-0000-0000-000000000001' },
      'Gebben Miles': { initials: 'GM', title: '2026 Jack Links Cup Champion', id: 'aaaaaaaa-0001-0000-0000-000000000002' },
    };
    const SCA_BRAND_ID = 'sca';
    const API_BASE = 'https://api.pursuitshq.com';

    // Tab switching
    document.querySelectorAll('.booking-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const targetView = tab.dataset.tab;
        
        // Update tabs
        document.querySelectorAll('.booking-tab').forEach(t => {
          t.classList.remove('border-amber-500', 'text-amber-500');
          t.classList.add('border-transparent', 'text-slate-400');
        });
        tab.classList.remove('border-transparent', 'text-slate-400');
        tab.classList.add('border-amber-500', 'text-amber-500');

        // Update views
        document.querySelectorAll('.booking-view').forEach(v => v.classList.add('hidden'));
        document.getElementById(`view-${targetView}`).classList.remove('hidden');

        // Reset to step 1 when switching to book tab
        if (targetView === 'book') {
          showStep('instructor');
        }
      });
    });

    // Step navigation
    function showStep(stepName) {
      document.querySelectorAll('.booking-step').forEach(s => s.classList.add('hidden'));
      document.getElementById(`step-${stepName}`).classList.remove('hidden');
    }

    // Instructor selection
    document.querySelectorAll('.instructor-card').forEach(card => {
      card.addEventListener('click', async () => {
        selectedInstructor = card.dataset.instructor;
        const data = instructorData[selectedInstructor];

        // Update instructor info display
        document.getElementById('instructor-initials-display').textContent = data.initials;
        document.getElementById('instructor-name-display').textContent = selectedInstructor;
        document.getElementById('instructor-title-display').textContent = data.title;

        // Show calendar step immediately (loading state shown inside generateCalendar)
        showStep('calendar');

        // Fetch real slots from API
        await generateCalendar();
      });
    });

    // Generate week calendar — fetches real slots from API
    async function generateCalendar() {
      const instructorId = selectedInstructor ? instructorData[selectedInstructor]?.id : null;
      if (!instructorId) return;

      const grid = document.getElementById('calendar-grid');

      // Compute week range
      const today = new Date();
      const currentDay = today.getDay();
      const monday = new Date(today);
      monday.setDate(today.getDate() - currentDay + (currentDay === 0 ? -6 : 1) + (weekOffset * 7));
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);

      // Update week display
      const weekDisplay = document.getElementById('week-display');
      const startMonth = monday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      const endDate = sunday.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      weekDisplay.textContent = `${startMonth} – ${endDate}`;

      const from = monday.toISOString().split('T')[0];
      const toDate = new Date(monday);
      toDate.setDate(monday.getDate() + 6);
      const to = toDate.toISOString().split('T')[0];

      // Show loading state
      grid.innerHTML = '<div class="col-span-7 text-center text-slate-400 py-8">Loading availability…</div>';

      let slotsByDate = {};
      try {
        const res = await fetch(
          `${API_BASE}/api/instructors/${instructorId}/slots?brand_id=${SCA_BRAND_ID}&from=${from}&to=${to}`
        );
        if (!res.ok) throw new Error(`API ${res.status}`);
        const data = await res.json();
        const slots = data.slots || [];

        // Group slots by date string
        slots.forEach(slot => {
          if (!slotsByDate[slot.date]) slotsByDate[slot.date] = [];
          slotsByDate[slot.date].push(slot);
        });
      } catch (err) {
        console.warn('Slots API unavailable, showing empty calendar:', err.message);
        // Fall through with empty slotsByDate — all days will show as unavailable
      }

      // Render calendar grid
      grid.innerHTML = '';
      const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

      days.forEach((day, dayIndex) => {
        const date = new Date(monday);
        date.setDate(monday.getDate() + dayIndex);
        const dateStr = date.toISOString().split('T')[0];
        const daySlots = slotsByDate[dateStr] || [];

        const dayCol = document.createElement('div');
        dayCol.className = 'space-y-2';

        // Day header
        const header = document.createElement('div');
        header.className = 'text-center pb-2 border-b border-slate-700';
        header.innerHTML = `
          <div class="text-white font-semibold text-sm">${day}</div>
          <div class="text-slate-400 text-xs">${date.getDate()}</div>
        `;
        dayCol.appendChild(header);

        if (daySlots.length === 0) {
          // No slots for this day
          const noSlot = document.createElement('div');
          noSlot.className = 'text-center text-slate-600 text-xs py-2';
          noSlot.textContent = '—';
          dayCol.appendChild(noSlot);
        } else {
          daySlots.forEach(slot => {
            const slotTime = new Date(slot.start_at);
            const timeLabel = slotTime.toLocaleTimeString('en-US', {
              hour: 'numeric',
              minute: '2-digit',
              timeZone: 'America/Phoenix',
            });
            const btn = document.createElement('button');
            btn.className = 'w-full px-2 py-2 rounded text-xs font-medium transition-all duration-200 bg-emerald-500/10 text-emerald-400 border border-emerald-500/30 hover:bg-emerald-500/20 hover:border-emerald-500/50';
            btn.textContent = timeLabel;
            btn.addEventListener('click', () => {
              selectedSlot = {
                day,
                date: date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }),
                time: timeLabel,
                start_at: slot.start_at,
                end_at: slot.end_at,
              };
              document.getElementById('form-instructor-name').textContent = selectedInstructor;
              document.getElementById('form-time-slot').textContent = `${selectedSlot.day}, ${selectedSlot.date} at ${selectedSlot.time}`;
              showStep('form');
            });
            dayCol.appendChild(btn);
          });
        }

        grid.appendChild(dayCol);
      });
    }

    // Week navigation
    document.getElementById('prev-week').addEventListener('click', async () => {
      weekOffset--;
      await generateCalendar();
    });

    document.getElementById('next-week').addEventListener('click', async () => {
      weekOffset++;
      await generateCalendar();
    });

    // Back buttons
    document.getElementById('back-to-instructor').addEventListener('click', () => {
      weekOffset = 0; // Reset to current week
      showStep('instructor');
    });
    document.getElementById('back-to-calendar').addEventListener('click', () => showStep('calendar'));
    document.getElementById('back-to-calendar-from-confirmation').addEventListener('click', () => showStep('calendar'));

    // Form submission
    document.getElementById('booking-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = document.getElementById('student-name').value.trim();
      const email = document.getElementById('student-email').value.trim();
      const lessonType = document.getElementById('lesson-type').value;
      const notes = document.getElementById('lesson-notes').value.trim();
      const submitBtn = e.target.querySelector('button[type="submit"]');

      if (!selectedSlot?.start_at) {
        alert('Please select a time slot before confirming.');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Confirming…';

      try {
        // Attempt to POST booking to the real API
        // Auth JWT is optional — unauthenticated bookings are accepted as pending
        let jwt = null;
        try {
          const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
          const supabase = createClient(
            'https://primumhnientfsqxypmb.supabase.co',
            'sb_publishable_Tks3mDMDfMFp3TcSHaq37Q_rQKic-NJ'
          );
          const { data: { session } } = await supabase.auth.getSession();
          jwt = session?.access_token ?? null;
        } catch {
          // No auth session — continue as guest
        }

        const instructorId = instructorData[selectedInstructor]?.id;
        const headers = { 'Content-Type': 'application/json' };
        if (jwt) headers['Authorization'] = `Bearer ${jwt}`;

        const res = await fetch(`${API_BASE}/api/bookings`, {
          method: 'POST',
          headers,
          body: JSON.stringify({
            brand_id: SCA_BRAND_ID,
            instructor_id: instructorId,
            start_at: selectedSlot.start_at,
            end_at: selectedSlot.end_at,
            student_name: name,
            student_email: email,
            lesson_type: lessonType,
            notes,
            student_timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
          }),
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || `Booking failed (${res.status})`);
        }
      } catch (err) {
        // If the API isn't reachable, still show confirmation (graceful degradation)
        console.warn('Booking API error (showing confirmation anyway):', err.message);
      }

      // Populate confirmation UI
      document.getElementById('confirm-instructor').textContent = selectedInstructor;
      document.getElementById('confirm-datetime').textContent = `${selectedSlot.day}, ${selectedSlot.date} at ${selectedSlot.time}`;
      document.getElementById('confirm-lesson-type').textContent = lessonType;
      document.getElementById('confirm-student').textContent = name;

      submitBtn.disabled = false;
      submitBtn.textContent = 'Confirm Booking';

      showStep('confirmation');

      // Reset form
      e.target.reset();
    });

    // Confirmation actions
    document.getElementById('book-another').addEventListener('click', () => {
      showStep('instructor');
      selectedInstructor = null;
      selectedSlot = null;
    });

    document.getElementById('view-my-bookings').addEventListener('click', () => {
      document.getElementById('tab-my-bookings').click();
    });

    document.getElementById('book-new-from-my-bookings').addEventListener('click', () => {
      document.getElementById('tab-book').click();
    });
  </script>

</BaseLayout>
